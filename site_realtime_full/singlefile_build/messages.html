<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>消息 · 实时</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    body{background:#000;color:#fff}
    .container{max-width:1000px;margin:0 auto;padding:16px}
    .title{color:#fff}
    .panel{background:#000;border:1px solid #222;border-radius:14px;padding:12px}
    .row{display:flex;gap:.8rem;align-items:center}
    .list{list-style:none;padding:0;margin:0}
    .input{width:100%;padding:.6rem;border:1px solid #222;border-radius:12px;background:#0a0a0a;color:#fff}
    .btn{padding:.5rem .8rem;border:1px solid #222;border-radius:12px;background:#0b0b0b;color:#fff;cursor:pointer}
    .btn.primary{background:#ff9900;border-color:#ff9900;color:#000}
    .grid{display:grid;grid-template-columns:280px 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .rowline{padding:.4rem .6rem;border-top:1px solid #222;display:flex;justify-content:space-between;align-items:center;gap:.6rem}
    .muted{color:#b5b5b5}
  </style>
</head>
<body>
<main class="container">
  <h2 class="title">消息</h2>
  <button onclick="location.href='index.html'" class="btn primary" style="margin:.5rem 0">返回首页</button>

  <section class="panel">
    <div class="row" style="align-items:flex-start;flex-wrap:wrap">
      <div class="panel" style="flex:1;min-width:280px">
        <h3 class="title">通过 6 位 ID 添加好友</h3>
        <div class="row" style="flex-wrap:wrap">
          <input id="friendId" class="input" maxlength="6" placeholder="输入 6 位 ID"/>
          <button id="btnFind" class="btn primary">查找</button>
        </div>
        <div id="friendProfile" class="muted" style="margin-top:.4rem"></div>
        <button id="btnSendReq" class="btn primary" disabled style="margin-top:.5rem">发送好友申请</button>
      </div>
      <div class="panel" style="flex:1;min-width:280px">
        <h3 class="title">新建群聊（至少 3 人）</h3>
        <input id="gName" class="input" placeholder="群聊名称（可选）"/>
        <small class="muted">输入成员 UID（逗号分隔，自动包含你自己）</small>
        <input id="gMembers" class="input" placeholder="uid1, uid2, uid3" style="margin-top:.3rem"/>
        <button id="btnCreateGroup" class="btn primary" style="margin-top:.5rem">新建群聊</button>
      </div>
    </div>
  </section>

  <section class="panel grid" style="margin-top:1rem">
    <aside>
      <h3 class="title">我的会话</h3>
      <ul id="chatList" class="list"></ul>

      <div class="panel" style="margin-top:1rem">
        <h4 class="title" style="font-size:1.05rem">新建私聊</h4>
        <div class="row" style="flex-wrap:wrap">
          <input id="dmUid" class="input" placeholder="输入对方 UID（不是6位ID）"/>
          <button id="btnCreateDM" class="btn primary">新建私聊</button>
        </div>
      </div>
    </aside>
    <section>
      <div class="panel">
        <h3 class="title" id="chatTitle">请选择会话或群聊</h3>
        <ul id="msgList" class="list" style="max-height:380px;overflow:auto"></ul>
        <div class="row" style="gap:.5rem;margin-top:.6rem">
          <input id="msgInput" class="input" placeholder="输入消息…"/>
          <button id="btnSend" class="btn primary">发送</button>
        </div>
      </div>

      <div class="panel" id="adminPanel" style="margin-top:1rem;display:none">
        <h4 class="title" style="font-size:1.05rem">群管理</h4>
        <div class="row" style="flex-wrap:wrap">
          <button id="btnAnn" class="btn primary">发布群公告</button>
          <button id="btnInvite" class="btn primary">邀请成员</button>
          <button id="btnLeave" class="btn primary">退出群聊</button>
          <button id="btnDissolve" class="btn primary">解散群（群主）</button>
        </div>
        <div class="row" style="flex-wrap:wrap;margin-top:.5rem">
          <input id="manageUid" class="input" placeholder="目标 UID"/>
          <button id="btnBlacklist" class="btn primary">拉黑</button>
          <button id="btnMute" class="btn primary">禁言 10 分钟</button>
          <button id="btnKick" class="btn primary">踢出</button>
          <button id="btnSetAdmin" class="btn primary">设为管理员</button>
          <button id="btnUnsetAdmin" class="btn primary">取消管理员</button>
        </div>
      </div>
    </section>
  </section>
</main>

<script type="module">
  import { initRealtime, ensureProfile, getCurrentUid, findUserById6, sendFriendRequest,
           createGroup, createDM, listMyChats, sendMessage, subscribeMessages, recallMessage,
           postAnnouncement, inviteMember, kickMember, muteMember, blacklistMember,
           setAdmins, leaveGroup, dissolveGroup } from "../js/social_realtime.js";

  const MODE = 'FIREBASE'; // 'DEMO' 开箱即用；要跨设备实时改成 'FIREBASE' 并填配置
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyD8M45qHEB9nTOJXvnTT3Qun3KpgDBaDiY",
    authDomain: "video-b128b.firebaseapp.com",
    projectId: "video-b128b",
    storageBucket: "video-b128b.appspot.com",
    messagingSenderId: "582799197303",
    appId: "1:582799197303:web:73b28db2a2e00ef95f7272",
    measurementId: "G-M9PPP5KMN4"
  };

  const $ = id => document.getElementById(id);

  (async function start(){
    await initRealtime({ mode: MODE, firebaseConfig: FIREBASE_CONFIG });
    await ensureProfile();

    // 好友 6 位 ID
    let found=null;
    $('btnFind').onclick = async ()=>{
      const id = ($('friendId').value||'').trim();
      if(!/^\d{6}$/.test(id)) return alert('请输入 6 位数字 UID');
      const u = await findUserById6(id);
      if(!u){ $('friendProfile').innerHTML='<div class="muted">未找到用户</div>'; $('btnSendReq').disabled=true; return; }
      found = u;
      $('friendProfile').innerHTML = `<div class="muted">UID：${u.id6||u.uid} · ${u.displayName||''}<br>${u.bio||''}</div>`;
      $('btnSendReq').disabled=false;
    };
    $('btnSendReq').onclick = async ()=>{
      if(!found) return;
      await sendFriendRequest(found.uid||found.id6);
      alert('已发送好友申请');
    };

    // 新建群聊
    $('btnCreateGroup').onclick = async ()=>{
      const name=$('gName').value.trim();
      const arr=($('gMembers').value||'').split(',').map(s=>s.trim()).filter(Boolean);
      try{ const gid=await createGroup(name, arr); alert('已创建群聊：'+gid); await renderChatList(); }catch(e){ alert(e.message||'失败'); }
    };

    // 新建私聊
    $('btnCreateDM').onclick = async ()=>{
      const partner = ($('dmUid').value||'').trim(); if(!partner) return;
      try{ const cid=await createDM(partner); alert('已创建私聊：'+cid); await renderChatList(); }catch(e){ alert(e.message||'失败'); }
    };

    // 会话列表 & 进入聊天
    let currentChat=null;
    async function renderChatList(){
      const list=$('chatList'); list.innerHTML='';
      const unsub = await listMyChats((arr)=>{
        list.innerHTML='';
        arr.forEach(chat=>{
          const li=document.createElement('li');
          const b=document.createElement('button'); b.className='btn'; b.style.display='block'; b.style.width='100%';
          b.textContent = chat.isGroup ? `群聊：${chat.name||chat.id}` : `私聊：${chat.id}`;
          b.onclick = ()=>{ currentChat = chat; $('chatTitle').textContent = chat.isGroup ? `群聊：${chat.name||chat.id}` : '私聊'; $('adminPanel').style.display = chat.isGroup ? '' : 'none'; renderMessages(chat.id); };
          li.appendChild(b); list.appendChild(li);
        });
        if(!arr.length){ list.innerHTML='<li class="muted">暂无会话</li>'; }
      });
    }

    // 消息订阅/撤回/发送
    let unsubMsg=null;
    async function renderMessages(chatId){
      if(unsubMsg) { unsubMsg(); unsubMsg=null; }
      unsubMsg = await subscribeMessages(chatId, (arr)=>{
        const box=$('msgList'); box.innerHTML='';
        const me = getCurrentUid();
        arr.forEach(m=>{
          const self = m.senderId===me;
          const li=document.createElement('li'); li.className='rowline';
          li.innerHTML = `<span>${m.recalled?'（已撤回）':(m.content||'')}</span>` + (self && !m.recalled ? `<button class="btn primary" data-mid="${m.id}">撤回</button>` : '');
          box.appendChild(li);
        });
        box.onclick = (e)=>{
          const btn = e.target.closest('button[data-mid]'); if(!btn) return;
          recallMessage(chatId, btn.dataset.mid);
        };
        box.scrollTop = box.scrollHeight;
      });
    }
    $('btnSend').onclick = async ()=>{
      if(!currentChat) return alert('先选择一个会话或群聊');
      const t = $('msgInput').value.trim(); if(!t) return;
      try{ await sendMessage(currentChat.id, t); $('msgInput').value=''; }catch(e){ alert(e.message||'发送失败'); }
    };

    // 群管理
    $('btnAnn').onclick = async ()=>{ if(!currentChat||!currentChat.isGroup) return; const t=prompt('公告内容'); if(!t) return; try{ await postAnnouncement(currentChat.id, t); alert('已发布'); }catch(e){ alert(e.message||'失败'); } };
    $('btnInvite').onclick = async ()=>{ if(!currentChat||!currentChat.isGroup) return; const u=prompt('输入要邀请的 UID'); if(!u) return; try{ await inviteMember(currentChat.id, u.trim()); alert('已邀请'); }catch(e){ alert(e.message||'失败'); } };
    $('btnLeave').onclick = async ()=>{ if(!currentChat||!currentChat.isGroup) return; if(!confirm('退出该群聊？')) return; try{ await leaveGroup(currentChat.id); currentChat=null; $('chatTitle').textContent='请选择会话或群聊'; $('msgList').innerHTML=''; renderChatList(); }catch(e){ alert(e.message||'失败'); } };
    $('btnDissolve').onclick = async ()=>{ if(!currentChat||!currentChat.isGroup) return; if(!confirm('仅群主操作：确认解散？不可恢复')) return; try{ await dissolveGroup(currentChat.id); currentChat=null; $('chatTitle').textContent='请选择会话或群聊'; $('msgList').innerHTML=''; renderChatList(); }catch(e){ alert(e.message||'失败'); } };
    $('btnBlacklist').onclick = async ()=>{ if(!currentChat||!currentChat.isGroup) return; const u=$('manageUid').value.trim(); if(!u) return; try{ await blacklistMember(currentChat.id, u); alert('已拉黑'); }catch(e){ alert(e.message||'失败'); } };
    $('btnMute').onclick = async ()=>{ if(!currentChat||!currentChat.isGroup) return; const u=$('manageUid').value.trim(); if(!u) return; try{ await muteMember(currentChat.id, u, 10); alert('已禁言'); }catch(e){ alert(e.message||'失败'); } };
    $('btnKick').onclick = async ()=>{ if(!currentChat||!currentChat.isGroup) return; const u=$('manageUid').value.trim(); if(!u) return; try{ await kickMember(currentChat.id, u); alert('已踢出'); }catch(e){ alert(e.message||'失败'); } };
    $('btnSetAdmin').onclick = async ()=>{ if(!currentChat||!currentChat.isGroup) return; const u=$('manageUid').value.trim(); if(!u) return; try{ await setAdmins(currentChat.id, [u]); alert('已设置管理员'); }catch(e){ alert(e.message||'失败'); } };
    $('btnUnsetAdmin').onclick = async ()=>{ if(!currentChat||!currentChat.isGroup) return; const u=$('manageUid').value.trim(); if(!u) return; try{ await setAdmins(currentChat.id, []); alert('已取消管理员'); }catch(e){ alert(e.message||'失败'); } };

    await renderChatList();
  })();
</script>
</body>
</html>
